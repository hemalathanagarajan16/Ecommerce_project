<section>
  <h2 class="title">Checkout</h2>
  <div class="layout">
    <form (ngSubmit)="placeOrder()" #f="ngForm" class="card">
      <div class="steps">
        <div [class.active]="step===1">1. Shipping</div>
        <div [class.active]="step===2">2. Payment</div>
        <div [class.active]="step===3">3. Review</div>
      </div>

      <!-- Step 1: Shipping Address -->
      <ng-container *ngIf="step === 1">
        <div class="field">
          <label>Name</label>
          <input name="name" [(ngModel)]="form.name" required />
        </div>
        <div class="grid2 addr">
          <div class="field" style="grid-column: 1 / -1;">
            <label>Street Address</label>
            <input name="street" [(ngModel)]="form.street" required />
          </div>
          <div class="field">
            <label>City</label>
            <input name="city" [(ngModel)]="form.city" required />
          </div>
          <div class="field" *ngIf="form.country !== 'Other'">
            <label>State</label>
            <select name="state" [(ngModel)]="form.state">
              <option value="" disabled>Select state</option>
              <ng-container *ngIf="form.country==='United States'">
                <option *ngFor="let s of usStates" [ngValue]="s">{{ s }}</option>
              </ng-container>
              <ng-container *ngIf="form.country==='India'">
                <option *ngFor="let s of indiaStates" [ngValue]="s">{{ s }}</option>
              </ng-container>
            </select>
          </div>
          <div class="field">
            <label>ZIP</label>
            <input name="zip" [(ngModel)]="form.zip" required />
          </div>
          <div class="field">
            <label>Country</label>
            <select name="country" [(ngModel)]="form.country">
              <option *ngFor="let c of countries" [ngValue]="c">{{ c }}</option>
            </select>
          </div>
        </div>
        <div class="field">
          <label>Email</label>
          <input name="email" type="email" [(ngModel)]="form.email" required />
        </div>
        <div class="field">
          <label>Shipping Method</label>
          <div class="segmented">
            <label><input type="radio" name="ship" [(ngModel)]="shippingMethod" value="standard" /> Standard (3–5 days)</label>
            <label><input type="radio" name="ship" [(ngModel)]="shippingMethod" value="express" /> Express (2–3 days)</label>
            <label><input type="radio" name="ship" [(ngModel)]="shippingMethod" value="overnight" /> Overnight</label>
          </div>
          <div class="muted">Estimated delivery: {{ estimatedDelivery }}</div>
        </div>
        <label class="terms"><input type="checkbox" [(ngModel)]="saveAddress" name="saveaddr" /> Save address for next time</label>
        <div class="actions">
          <button type="button" class="btn" (click)="next()">Continue to payment →</button>
        </div>
      </ng-container>

      <!-- Step 2: Payment -->
      <ng-container *ngIf="step === 2">
        <div class="field">
          <label>Payment Method</label>
          <div class="segmented">
            <label><input type="radio" name="payment" [(ngModel)]="paymentMethod" value="card" /> Card</label>
            <label><input type="radio" name="payment" [(ngModel)]="paymentMethod" value="paypal" /> PayPal</label>
            <label><input type="radio" name="payment" [(ngModel)]="paymentMethod" value="cod" /> Cash on Delivery</label>
          </div>
        </div>
        <div class="grid2" *ngIf="paymentMethod === 'card'">
          <div class="field">
            <label>Card Number</label>
            <input name="card" [(ngModel)]="form.card" placeholder="1234 5678 9012 3456" />
          </div>
          <div class="field sm">
            <label>Expiry (MM/YY)</label>
            <input name="expiry" [(ngModel)]="form.cardExpiry" placeholder="MM/YY" />
          </div>
          <div class="field sm">
            <label>CVV</label>
            <input name="cvv" [(ngModel)]="form.cardCvv" placeholder="123" />
          </div>
        </div>
        <div class="actions">
          <button type="button" class="btn ghost" (click)="back()">← Back</button>
          <button type="button" class="btn" (click)="next()">Review order →</button>
        </div>
      </ng-container>

      <!-- Step 3: Review -->
      <ng-container *ngIf="step === 3">
        <div class="review">
          <div>
            <h4>Shipping To</h4>
            <div>{{ form.name }}</div>
            <div>{{ form.street }}</div>
            <div>{{ form.city }}, {{ form.state }} {{ form.zip }}</div>
            <div>{{ form.country }}</div>
            <div class="muted">Email: {{ form.email }}</div>
          </div>
          <div>
            <h4>Payment</h4>
            <div>Method: {{ paymentMethod | titlecase }}</div>
            <div *ngIf="paymentMethod==='card'" class="muted">Card ending •••• {{ (form.card || '').slice(-4) }}</div>
          </div>
          <div>
            <h4>Delivery</h4>
            <div>Method: {{ shippingMethod | titlecase }}</div>
            <div class="muted">ETA: {{ estimatedDelivery }}</div>
          </div>
        </div>
        <label class="terms"><input type="checkbox" [(ngModel)]="agreeToTerms" name="terms" /> I agree to the Terms and Privacy Policy</label>
        <div class="actions">
          <button type="button" class="btn ghost" (click)="back()">← Back</button>
          <button class="btn" type="submit">Place Order</button>
        </div>
      </ng-container>

      <!-- Coupons always visible below steps -->
      <div class="field">
        <label>Coupon Code</label>
        <div class="flex gap-2">
          <input name="coupon" [(ngModel)]="couponCode" placeholder="SAVE10, FREESHIP, SAVE50" />
          <button type="button" class="btn" (click)="applyCoupon()">Apply</button>
          <button type="button" class="btn" *ngIf="appliedCoupon" (click)="appliedCoupon = undefined">Remove</button>
        </div>
        <div class="muted" *ngIf="appliedCoupon">Applied: {{ appliedCoupon.description }}</div>
      </div>
      <a routerLink="/" class="link">← Continue shopping</a>
    </form>
    <aside class="summary card">
      <h3>Order Summary</h3>
      <div class="items">
        <div class="row item" *ngFor="let i of (cart.items$ | async) ?? []">
          <div class="name">{{ i.product.name }}</div>
          <div class="qty">
            <button type="button" class="icon" (click)="decrement(i.product.id)">-</button>
            <span>{{ i.qty }}</span>
            <button type="button" class="icon" (click)="increment(i.product.id)">+</button>
          </div>
          <div class="price">{{ (i.product.price * i.qty) | currency }}</div>
          <button type="button" class="remove-btn" aria-label="Remove item" (click)="remove(i.product.id)">✕ Remove</button>
        </div>
      </div>
      <hr />
      <div class="row"><div>Subtotal</div><div>{{ cart.total | currency }}</div></div>
      <div class="row" *ngIf="discount > 0"><div>Discount</div><div>-{{ discount | currency }}</div></div>
      <div class="row"><div>Shipping</div><div>{{ shipping | currency }}</div></div>
      <div class="row"><div>Tax (8%)</div><div>{{ tax | currency }}</div></div>
      <div class="row total"><div>Order Total</div><div>{{ orderTotal | currency }}</div></div>
    </aside>
  </div>
</section>
